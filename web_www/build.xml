<?xml version="1.0" encoding="utf-8"?>
<project name="localemaps_www">
  <!--
  TODO:
  - Create target for solely deploying:
    - views (take argument)
    - controllers
      - have whether to update routes.php or not
    - models
  -->
  <property name="js.wrapper">(function(){%output%})();</property>
  <property name="apache_root_osx" location="/Applications/MAMP"/>
  <macrodef name="build-macro" description="Creates www directory structure and copies/creates PHP and image files.">
    <attribute name="debug" default="FALSE"/>
    <sequential>
      <copy todir="${dist}/www">
        <fileset file="${cake}/.htaccess"/>
      </copy>
      <copy todir="${dist}/www/cake">
        <fileset dir="${cake}/cake"/>
      </copy>
      <copy todir="${dist}/www/app">
        <fileset file="${cake}/app/.htaccess"/>
        <fileset file="${cake}/app/app_controller.php"/>
        <fileset file="${cake}/app/app_helper.php"/>
        <fileset file="${cake}/app/app_model.php"/>
        <fileset file="${cake}/app/index.php"/>
      </copy>
      <mkdir dir="${dist}/www/app/config"/>
      <xmlproperty file="config/www_${env}.xml"/>
      <copy todir="${dist}/www/app/config">
        <fileset file="${cake}/app/config/*.php"/>
        <fileset file="web_www/config/*.php"/>
        <filterset>
          <filter token="DB_NAME" value="${config.database.name}"/>
          <filter token="DB_PASSWORD" value="${config.database.www_user.password}"/>
          <filter token="DB_PORT" value="${config.database.port}"/>
          <filter token="DB_SERVER" value="${config.database.server}"/>
          <filter token="DB_USER" value="${config.database.www_user.username}"/>
        </filterset>
      </copy>
      <copy todir="${dist}/www/app/controllers">
        <fileset dir="web_www/controllers"/>
      </copy>
      <copy todir="${dist}/www/app/models">
        <fileset dir="web_www/models"/>
      </copy>
      <mkdir dir="${dist}/www/app/tmp/cache/persistent"/>
      <mkdir dir="${dist}/www/app/tmp/cache/models"/>
      <copy todir="${dist}/www/app/views/elements">
        <fileset dir="web_www/views/elements"/>
      </copy>
      <copy todir="${dist}/www/app/views/layouts">
        <fileset dir="web_www/views/layouts"/>
      </copy>
      <copy todir="${dist}/www/app/views/www_actions">
        <fileset dir="web_www/views/www_actions"/>
        <filterset>
          <filter token="GOOGLE_API_KEY" value="${config.google.api_key}"/>
        </filterset>
      </copy>
      <copy todir="${dist}/www/app/webroot">
        <fileset file="${cake}/app/webroot/.htaccess"/>
        <fileset file="${cake}/app/webroot/css.php"/>
        <fileset file="${cake}/app/webroot/index.php"/>
      </copy>
      <copy todir="${dist}/www/app/webroot/img">
        <fileset dir="static/img"/>
      </copy>
    </sequential>
  </macrodef>
  <macrodef name="build-css" description="Builds CSS files.">
    <sequential>
      <init-css/>
      <java
        jar="tools/yuicompressor-2.4.6.jar"
        fork="true"
        failonerror="true">
        <arg value="--type=css"/>
        <arg value="-o"/>
        <arg value="${dist}/www/app/webroot/css/default.css"/>
        <arg value="${build}/css/default.css"/>
      </java>
    </sequential>
  </macrodef>
  <macrodef name="build-css-debug" description="Builds CSS files (debug versions).">
    <sequential>
      <init-css/>
      <copy tofile="${dist}/www/app/webroot/css/default.css">
        <fileset file="${build}/css/default.css"/>
      </copy>
    </sequential>
  </macrodef>
  <macrodef name="init-css" description="Builds intermediate CSS files.">
    <sequential>
      <mkdir dir="${build}/css"/>
      <concat destfile="${build}/css/default.css">
        <filelist dir="static/css/www" files="default.css,locale_info.css"/>
      </concat>
      <mkdir dir="${dist}/www/app/webroot/css"/>
    </sequential>
  </macrodef>
  <macrodef name="build-js" description="Builds JS files.">
    <attribute name="debug" default="FALSE"/>
    <sequential>
      <mkdir dir="${dist}/www/app/webroot/js"/>
      <java
        jar="tools/compiler.jar"
        fork="true"
        failonerror="true">
        <arg value="--js=static/js/lib/jquery-1.6.2.js"/>
        <arg value="--js=static/js/apps/www/home_page.js"/>
        <arg value="--compilation_level"/>
        <arg value="ADVANCED_OPTIMIZATIONS"/>
        <arg value="--js_output_file=${dist}/www/app/webroot/js/home_page.js"/>
        <arg value="--output_wrapper=${js.wrapper}"/>
      </java>
    </sequential>
  </macrodef>
  <macrodef name="build-js-debug" description="Builds JS files (debug versions).">
    <attribute name="debug" default="FALSE"/>
    <sequential>
      <mkdir dir="${dist}/www/app/webroot/js"/>
      <java
        jar="tools/compiler.jar"
        fork="true"
        failonerror="true">
        <arg value="--js=static/js/lib/jquery-1.6.2.js"/>
        <arg value="--js=static/js/apps/www/home_page.js"/>
        <arg value="--formatting=PRETTY_PRINT"/>
        <arg value="--compilation_level"/>
        <arg value="WHITESPACE_ONLY"/>
        <arg value="--js_output_file=${dist}/www/app/webroot/js/home_page.js"/>
        <arg value="--output_wrapper=${js.wrapper}"/>
      </java>
    </sequential>
  </macrodef>
  <target name="build">
    <delete includeemptydirs="true" failonerror="false">
      <fileset dir="${apache_root_osx}/htdocs"/>
    </delete>
    <symlink action="delete" link="${apache_root_osx}/htdocs"/>
    <build-macro/>
    <build-js/>
    <build-css/>
    <symlink link="${apache_root_osx}/htdocs" resource="${dist}/www"/>
  </target>
  <target name="build-debug">
    <delete includeemptydirs="true" failonerror="false">
      <fileset dir="${apache_root_osx}/htdocs"/>
    </delete>
    <build-macro/>
    <build-js-debug/>
    <build-css-debug/>
    <symlink link="${apache_root_osx}/htdocs" resource="${dist}/www"/>
  </target>
  <target name="build-css">
    <build-css/>
  </target>
  <target name="build-css-debug">
    <build-css-debug/>
  </target>
  <target name="build-js">
    <build-js/>
  </target>
  <target name="build-js-debug">
    <build-js-debug/>
  </target>
</project>
